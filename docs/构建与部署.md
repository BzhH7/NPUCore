# NPUcore-Ovo 构建与部署文档

## 1. 开发环境配置

### 1.1 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Linux (推荐 Ubuntu 20.04+) |
| 内存 | >= 8GB |
| 磁盘空间 | >= 20GB |
| 网络 | 需要访问 crates.io 和 GitHub |

### 1.2 Docker 环境 (推荐)

使用官方提供的 Docker 镜像可以快速搭建开发环境：

```bash
# 拉取镜像
docker pull docker.educg.net/cg/os-contest:2024p8.3

# 启动容器
docker run -it --privileged \
    -v "$(pwd):/root/workspace" \
    -w /root/workspace \
    docker.educg.net/cg/os-contest:2024p8.3 /bin/bash
```

### 1.3 本地环境配置

#### 1.3.1 安装 Rust 工具链

```bash
# 安装 Rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 配置环境变量
source $HOME/.cargo/env

# 安装指定版本的 nightly 工具链
rustup default nightly-2024-02-03-x86_64-unknown-linux-gnu

# 添加目标架构
rustup target add riscv64gc-unknown-none-elf

# 安装必要组件
cargo install cargo-binutils
rustup component add llvm-tools-preview
rustup component add rust-src
```

#### 1.3.2 安装 QEMU

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install qemu-system-riscv64 qemu-system-misc

# 或者从源码编译获取最新版本
```

#### 1.3.3 安装其他工具

```bash
# 安装必要的工具
sudo apt install build-essential git wget curl

# 安装 GDB (可选,用于调试)
sudo apt install gdb-multiarch

# 或者安装 RISC-V 专用工具链
# sudo apt install gcc-riscv64-linux-gnu
```

### 1.4 LoongArch 环境配置

#### 1.4.1 下载 QEMU

```bash
# 使用项目提供的脚本下载
make qemu-download

# 或手动下载
QEMU_URL=https://gitlab.educg.net/wangmingjian/os-contest-2024-image/-/raw/master/qemu-2k1000-static.20240526.tar.xz
wget -P util/qemu-2k1000/tmp $QEMU_URL
cd util/qemu-2k1000/tmp && tar xavf qemu-2k1000-static.20240526.tar.xz
```

## 2. 项目构建

### 2.1 快速构建

```bash
# 进入项目根目录
cd oskernel2025-ovo

# 配置环境
make env

# 构建 RISC-V 版本 (默认)
make all

# 或者只构建内核
make kernel
```

### 2.2 分架构构建

#### 2.2.1 RISC-V 64 构建

```bash
# 进入 os 目录
cd os

# 构建 QEMU 版本
make -f make/rv64.mk all

# 仅构建内核
make -f make/rv64.mk kernel

# 构建 debug 版本
make -f make/rv64.mk all MODE=debug

# 构建 VisionFive2 开发板版本
make -f make/rv64.mk all BOARD=visionfive2 BLK_MODE=mem
```

#### 2.2.2 LoongArch 64 构建

```bash
cd os

# 构建 QEMU 版本
make -f make/la64.mk all

# 构建 2K1000 开发板版本
make -f make/la_board/la64board.mk all BLK_MODE=mem BOARD=2k1000
```

### 2.3 构建选项

| 选项 | 可选值 | 默认值 | 描述 |
|------|-------|--------|------|
| MODE | release/debug | release | 构建模式 |
| BOARD | rvqemu/visionfive2/laqemu/2k1000 | rvqemu | 目标平台 |
| BLK_MODE | virt/mem/sata | virt | 块设备类型 |
| FS_MODE | fat32/ext4 | fat32 | 文件系统类型 |
| LOG | off/error/warn/info | off | 日志级别 |

### 2.4 Feature Flags

项目使用 Cargo features 控制功能模块：

```toml
[features]
# 内存管理
zero_init = []        # 零初始化所有内存
swap = []             # 启用交换分区
zram = []             # 启用 ZRAM 压缩
oom_handler = ["swap", "zram"]  # OOM 处理

# 日志级别
log_off = ["log/max_level_off"]
log_info = ["log/max_level_info"]
log_warn = ["log/max_level_warn"]
log_error = ["log/max_level_error"]

# 块设备
block_sata = []
block_mem = []
block_virt = []
block_virt_pci = []

# 架构选择
riscv = []
loongarch64 = []

# 平台选择
board_rvqemu = ["oom_handler", "riscv"]
board_visionfive2 = ["oom_handler", "riscv"]
board_laqemu = ["oom_handler", "loongarch64"]
board_2k1000 = ["oom_handler", "loongarch64"]
```

### 2.5 构建产物

构建完成后，在 `os/target/` 目录下生成：

```
os/target/
└── riscv64gc-unknown-none-elf/
    └── release/
        ├── os              # ELF 格式内核
        └── os.bin          # 二进制内核镜像
```

最终内核文件会被复制到项目根目录：
- `kernel-qemu` - RISC-V QEMU 内核
- `kernel-la` - LoongArch 内核

## 3. 文件系统镜像

### 3.1 创建文件系统镜像

```bash
# 进入 os 目录
cd os

# 创建默认 FAT32 镜像
make -f make/rv64.mk fs-img

# 创建 EXT4 镜像
make -f make/rv64.mk fs-img FS_MODE=ext4
```

### 3.2 镜像结构

```
fs-img-dir/
└── fs/
    ├── bin/        # 用户程序
    ├── etc/        # 配置文件
    ├── root/       # root 用户目录
    └── var/        # 变量数据
```

### 3.3 添加用户程序

```bash
# 构建用户程序
cd user
make rust-user BOARD=rvqemu MODE=release

# 用户程序会被复制到 fs-img-dir/fs/bin/
```

## 4. 运行与测试

### 4.1 QEMU 运行

#### 4.1.1 RISC-V QEMU

```bash
# 使用自定义文件系统镜像
cd os
make -f make/rv64.mk run

# 使用标准 sdcard 镜像 (竞赛模式)
make -f make/rv64.mk test

# 竞赛测试模式
make -f make/rv64.mk comp
```

#### 4.1.2 LoongArch QEMU

```bash
cd os

# 运行
make -f make/la64.mk runsimple

# 竞赛模式
make -f make/la64.mk comp
```

### 4.2 QEMU 参数说明

```bash
qemu-system-riscv64 \
    -machine virt \                    # 使用 virt 机器
    -kernel kernel-qemu \              # 内核镜像
    -m 1024 \                          # 内存大小 1GB
    -nographic \                       # 无图形界面
    -smp 1 \                           # CPU 核心数
    -bios default \                    # 使用默认 OpenSBI
    -drive file=sdcard.img,if=none,format=raw,id=x0 \  # 磁盘镜像
    -device virtio-blk-device,drive=x0 \              # VirtIO 块设备
    -no-reboot \                       # 不自动重启
    -rtc base=utc                      # RTC 时间
```

### 4.3 GDB 调试

#### 4.3.1 启动调试服务器

```bash
cd os

# RISC-V debug 模式
make -f make/rv64.mk rv64-gdb

# 或手动启动
qemu-system-riscv64 ... -S -s
```

#### 4.3.2 连接 GDB

```bash
# 使用 riscv64 GDB
riscv64-unknown-elf-gdb \
    -ex 'file target/riscv64gc-unknown-none-elf/debug/os' \
    -ex 'set arch riscv:rv64' \
    -ex 'target remote localhost:1234'

# 或使用 gdb-multiarch
gdb-multiarch \
    -ex 'file target/riscv64gc-unknown-none-elf/debug/os' \
    -ex 'set arch riscv:rv64' \
    -ex 'target remote localhost:1234'
```

#### 4.3.3 常用 GDB 命令

```gdb
# 设置断点
break rust_main
break *0x80200000

# 继续执行
continue

# 单步执行
stepi
nexti

# 查看寄存器
info registers

# 查看内存
x/10x 0x80200000

# 查看调用栈
backtrace
```

## 5. 开发板部署

### 5.1 VisionFive2 开发板

#### 5.1.1 构建

```bash
cd os
make -f make/rv64.mk all BOARD=visionfive2 BLK_MODE=mem
cp ../kernel-rv ../os.bin
```

#### 5.1.2 部署

1. 将 `os.bin` 复制到 SD 卡
2. 使用 U-Boot 加载内核
3. 通过串口连接控制台

### 5.2 龙芯 2K1000 开发板

#### 5.2.1 构建

```bash
cd os
make -f make/la_board/la64board.mk all BLK_MODE=mem BOARD=2k1000
```

#### 5.2.2 部署

1. 将内核镜像烧录到 Flash
2. 配置 PMON/U-Boot
3. 通过串口连接

## 6. 持续集成

### 6.1 自动化构建脚本

```bash
#!/bin/bash
# ci/build.sh

set -e

# 设置环境
make env

# 构建 RISC-V 版本
cd os
make -f make/rv64.mk clean
make -f make/rv64.mk kernel MODE=release
make -f make/rv64.mk fs-img

# 构建 LoongArch 版本
make -f make/la64.mk clean
make -f make/la64.mk kernel MODE=release

echo "Build completed successfully!"
```

### 6.2 测试脚本

```bash
#!/bin/bash
# ci/test.sh

set -e

cd os

# 运行 QEMU 测试 (带超时)
timeout 60 make -f make/rv64.mk test || {
    echo "Test failed or timed out"
    exit 1
}

echo "Tests passed!"
```

---

*文档版本: 1.0*  
*最后更新: 2026年1月*
