# 模拟现场赛题目
共计3个题目，各为50分

各位同学独立完成题目，完成后向老师和助教展示结果并讲述思路和具体实现。

三个任务分别为truncate、fstatfs及prctl
可以通过makefile自行编译生成二进制程序并制作对应的内核镜像。

## task1——truncate (Path-based)

### 赛题介绍

本题目需要我们实现系统调用`truncate`，用于根据文件路径将指定文件的大小调整为给定的长度。该系统调用是文件系统管理中的核心功能，常用于清空文件内容或预分配磁盘空间。其对应用户库函数的声明为：
```C
#include <unistd.h>
#include <sys/types.h>
int truncate(const char *path, off_t length);
```
truncate() 会将 path 指向的普通文件的大小修改为等于 length 字节。

功能要求：

    缩小文件（Shrink）：如果文件原先大于 length，则多出的数据将丢失。

    扩展文件（Extend）：如果文件原先小于 length，则文件将被扩展，扩展部分在读取时应返回零字节（即逻辑上的“空洞”或零填充）。

    文件偏移：truncate() 不改变任何已打开文件描述符的文件偏移（File Offset）。

    符号链接：如果 path 是一个符号链接（Symlink），则系统调用应作用于链接指向的源文件（即解引用 Dereference）。

返回值：

    成功执行时返回 0。

    出现错误时返回负值（如：-ENOENT 表示路径不存在，-EINVAL 表示长度非法）。

### 测试点说明：

现场赛共设置 5 个测试维度，每个维度对应一个生成的测例程序（每个测试点 10 分）：

    case1: 文件缩减测试

        创建一个包含数据的普通文件，将其缩减至较小尺寸（如 10 字节）。

        验证点：文件大小更新正确，且保留下来的头部数据内容未受破坏。

    case2: 文件扩展与零填充测试

        将一个短文件扩展至较大尺寸（如 100 字节）。

        验证点：文件大小更新正确，且原有数据后的扩展区域必须读取为 \0。

    case3: 边界情况与错误处理测试

        包括：将文件截断为 0 字节；尝试使用负数长度（应返回 -EINVAL）；访问不存在的路径（应返回 -ENOENT）。

        验证点：内核对异常输入有健壮的校验机制。

    case4: 符号链接支持测试

        对指向普通文件的符号链接调用 truncate。

        验证点：内核能够正确解引用，修改的是原始文件而非链接文件本身。

    case5: 综合压力测试

        对同一文件连续进行多次不同尺寸的缩减与扩展操作（如 1024 -> 0 -> 512 -> 2048 -> 10）。

        验证点：内核在高频元数据修改下保持文件系统一致性。

### 参考

- [truncate(2)](https://man7.org/linux/man-pages/man2/truncate.2.html)

## task2——fstatfs
### 赛题介绍

本题目需要我们实现系统调用 fstatfs，用于返回有关已打开文件所在文件系统的信息。这要求内核能够从底层文件系统结构（如 ext4 的 Superblock 或 FAT32 的 DBPB）中提取状态数据并填充到用户态缓冲区中。其对应用户库函数的声明为：
```C
#include <sys/vfs.h>    /* 或者 <sys/statfs.h> */
int fstatfs(int fd, struct statfs *buf);
```
fstatfs() 会查询文件描述符 fd 指向的文件所在的文件系统，并将结果填入 buf 指向的结构体中。

功能要求：

    元数据提取：至少需要正确填充 f_type（文件系统类型）、f_blocks（总数据块数）、f_bfree（空闲块数）和 f_namelen（最大文件名长度）。

    健壮性校验：

        若 fd 无效，应返回 -EBADF。

        若 buf 地址非法，应返回 -EFAULT。

    跨文件系统一致性：内核应能识别不同挂载点（如根目录与 /proc）下不同的文件系统特征。

返回值：

    成功执行时返回 0。

    出现错误时返回负值。


### 测试点说明

本任务通过编译 fstatfs.c 生成 4 个测例，每个测例 12.5 分：

    case1: 目录读取测试：验证在 /tmp 目录下能否正确获取文件系统基本信息。

    case2: 无效文件描述符处理：传入 -1，验证内核是否返回 -EBADF。

    case3: 非法地址校验：传入 NULL ，验证内核是否触发 -EFAULT。

    case4: 普通文件适配测试：对常规打开的磁盘文件调用 fstatfs，验证其能否溯源至所属文件系统。

### 参考

- [fstatfs(2)](https://man7.org/linux/man-pages/man2/statfs.2.html)

## task3——prctl (Process Control)

### 赛题介绍

本题目需要我们实现一个多功能的系统调用 prctl，用于对当前进程进行各种形式的控制和状态获取。由于 prctl 的功能极其广泛，本次赛题主要考察进程更名与父进程死亡信号两个核心子功能。其对应用户库函数的声明为：

```C
#include <sys/prctl.h>
int prctl(int option, unsigned long arg2, unsigned long arg3,
          unsigned long arg4, unsigned long arg5);
```

功能要求：

    PR_SET_NAME / PR_GET_NAME：设置或获取调用进程的名称（线程名）。

        长度限制：名称最多为 15 字节，超过部分需截断。

    PR_SET_PDEATHSIG / PR_GET_PDEATHSIG：

        设置当父进程退出时，发给当前子进程的信号（如 SIGTERM）。

        若设置为 0，则清除该信号。

    参数校验：

        对于未实现的 option 或非法的信号值，应返回 -EINVAL。

        对于需要写入数据的地址参数（如 arg2），应进行内存合法性检查。


### 测试点说明

本任务通过编译 prctl.c 生成 5 个测例，每个测例 10 分：

    case1: 进程名设置与获取：验证 PR_SET_NAME 后通过 PR_GET_NAME 读回的数据是否一致，并检查 15 字节截断逻辑。

    case2: 父进程死亡信号控制：验证能否正确设置和清除 PDEATHSIG，并检查信号范围合法性。

    case3: 无效选项拦截：传入内核不支持的 option 编号，验证是否返回 -EINVAL。

    case4: 内存边界校验：在 GET 类操作中传入 NULL 指针或非法用户地址，验证内核是否返回 -EFAULT。

    case5: 综合一致性测试：在同一进程中交叉执行更名与信号设置，验证内核管理进程控制块（PCB）时的资源稳定性。

### 参考
- [prctl(2)](https://man7.org/linux/man-pages/man2/prctl.2.html)